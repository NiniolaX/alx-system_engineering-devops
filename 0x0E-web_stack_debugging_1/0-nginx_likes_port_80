#!/usr/bin/env bash
# Bash script that fixes an Ubuntu container's Nginx installation

# Curl the server
test1=$(curl 0:80)

if [ "$test1" != "curl: (7) Failed to connect to 0.0.0.0 port 80 after 0 ms: Connection refused" ]; then
	exit
fi

# Check if nginx is started
test2=$(service nginx status)

if [ "$test2" = "nginx: unrecognized service" ]; then
	sudo apt -y update
	sudo apt install -y nginx
	sudo service nginx start
elif [ "$test2" = "^ nginx is not running" ]; then
	sudo service nginx start
else
	echo "$test2"
fi

# Check if nginx is listening on port 80
sudo apt install -y net-tools

test3=$(sudo netstat -lpn | grep nginx | grep :80)

if [ -n "$test3" ]; then
	echo "nginx is running and listening on port 80"
else
	sudo apt install -y ufw
	sudo ufw allow 'Nginx HTTP'
	sudo service nginx restart
fi
